# 食事プラン生成設計書（Anchor & Fill 戦略）

## 1. 概要
FaveFitのコアコンセプトである「ユーザーのストレス軽減」と「確実な目標達成」を両立するため、食事プラン生成ロジックを段階的生成（Anchor & Fill）方式に刷新する。

## 2. ユーザーインターフェース (UI) の変更
複雑なロジックを避けるため、フロントエンド（オンボーディング）で入力の排他制御を行う。

### 2.1 入力項目の変更
各食事スロット（朝食・昼食・夕食）に対して、以下の3つのモードから1つを選択する形式とする。
- **おまかせ (Auto):** AIが目標に合わせて献立を自由に作成。
- **固定メニュー (Fixed):** 毎日食べる決まったメニューを指定。メニュー名に加え「ご飯は100g以下」などの詳細な要望も併記可能。
- **こだわり要望 (Custom):** 「コンビニで済ませたい」「300kcal以下」などの条件を指定。

### 2.2 UI制約
- 「固定メニュー」を選択した場合、そのスロットの「こだわり要望」入力欄は非表示となる（固定メニュー欄に集約）。
- これにより、バックエンドに届く指示から競合（矛盾）を排除し、ロジックをシンプルに保つ。

## 3. プラン生成ワークフロー (Backend)

新しい生成フローは以下の4ステップで構成される。

### Step 1: Auditor（事前監査と見積もり）
軽量AIモデル（Gemini Flash等）を使用して、確定している枠（アンカー枠）の栄養素を概算する。
- **入力:** ユーザーの選択（Fixed または Custom）と入力テキスト。
- **処理:** 
    - Fixed（固定）の場合：料理名と併記された要望（量、調理法など）から栄養素を推定。
    - Custom（要望）の場合：要望に含まれる制約（例：500kcal以下）を考慮して、上限に近い栄養素を推定。
- **出力:** アンカー枠の暫定タイトルと推定栄養価。

### Step 2: 栄養予算の算出 (Budget Calculation)
システム内で単純計算を行い、AIが自由に作成できる「残り枠」の目標値を算出する。
- **計算式:** `1日の合計目標 - Σ(アンカー枠の推定栄養価) = 残り枠の栄養予算`
- **安全性チェック:** 残り枠の予算が極端に少ない（例：夕食1回で1500kcal必要になる等）場合、警告フラグを立てる。

### Step 3: Fill Planner（残りの枠埋め）
メインAIモデルを使用して、「おまかせ」に設定されたスロットの献立を生成する。
- **指示:** 「既にこれらの枠（アンカー）は確定しています。残りの栄養予算を目標に、おまかせ枠を埋めてください。」
- **メリット:** AIは引き算済みの「残り数値」だけを見ればよいため、1日全体の帳尻合わせに失敗するリスクが激減する。

### Step 4: 統合と保存
すべてのスロットを統合し、承認待ち（Pending）プランとして保存する。

## 4. プロンプト設計の変更

### 4.1 Auditor用プロンプト (新規)
- 特定のスロットの名称と条件から、妥当な栄養素数値を1つ導き出すことに特化させる。

### 4.2 Fill Planner用プロンプト (リファクタリング)
- 1日全体の目標値ではなく、スロット単位または「残りの総計」を目標値として受け取れるように変更。

## 5. 実装スケジュール案
1. **Frontend:** `src/app/onboarding/page.tsx` のフォーム改修。
2. **Types:** `PlanGeneratorInput` の型定義に排他制御の構造を反映。
3. **Backend:** `meal-plan-generation.ts` のフローを Anchor & Fill に書き換え。
4. **Prompt:** Auditor および Fill Planner のプロンプト調整。

## 6. 将来の拡張性
- Auditorが「目標達成不可能」と判断した場合、将来的にUI側で「目標を緩めますか？」というダイアログを出すためのフック（警告フラグ）をあらかじめデータ構造に含めておく。
