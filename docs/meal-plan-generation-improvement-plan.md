# 食事プラン生成の改善計画 (Anchor & Fill 戦略の強化)

## 目的
1.  **固定メニューの確実な採用:** メニュー名の微差によるバリデーション失敗と、その後のフォールバック（鶏胸肉メニューへの差し替え）を排除します。
2.  **AIによる固定メニューの栄養価計算:** `Auditor` エージェントが算出した栄養価を「正解」として扱い、プラン全体に反映させます。
3.  **こだわり要望の尊重:** 「固定（Fixed）」は動かないアンカーとし、「こだわり（Custom）」は固定枠以外の不足分を埋める際の制約として機能させます。
4.  **適応型プランニングの導入:** ユーザーの現在の食習慣を把握し、人間が食べきれないような過剰な量を提案しないようにします。

## 実施ステップ

### 1. `runAnchorAndFillProcess` の戻り値の拡張
`runAnchorAndFillProcess` がプランデータだけでなく、Auditorが解決したアンカー情報（正規化されたタイトルと推定栄養価）も返すように変更します。これにより、メインワークフローで AI が算出した正確な固定メニューデータを利用可能にします。

### 2. `generateMealPlan` ワークフローの更新
メイン関数において、Auditorの結果をバリデーションステップに渡すようにします。ユーザーの生入力（`input.fixedMeals`）ではなく、AIが解決した「信頼できる固定メニュー」を使用します。

### 3. バリデーションロジック (`validatePlanNutrition`) の改善
固定メニューの判定を、あやふやな文字列一致（`.includes()`）から、`mealType`（朝・昼・晩）に基づいた明確な判定に変更します。
- スロットが固定メニュー（Anchor）に該当する場合：
    - 標準の「目標値±15%」の栄養素チェックをスキップします（ユーザーの選択を最優先するため）。
    - タイトル一致チェックをスキップ、または Auditor の結果を正として扱います。
    - **重要:** 最終的なプランの栄養価を、Fill Planner の推定値ではなく、Auditor の推定値で上書きして整合性を確保します。

### 4. 適応型ポーションコントロールの実装
`DietBaselineService` およびプロンプト生成を強化します。
- `currentDiet` から各食事の平均摂取量を算出し、AIへの指示（`adaptiveDirective`）に「1食あたりの上限」などの制約を明示的に含めます。
- 帳尻合わせのために無理な量を提案しないよう、プロンプトに強い制約（Negative Prompt）を追加します。

## 主な変更箇所

### `src/server/ai/workflows/meal-plan-generation.ts`
- `runAnchorAndFillProcess` のインターフェースを変更し、`resolvedAnchors` を返すようにします。
- 生成されたプランに対し、Auditor が解決したタイトルと栄養価で固定スロットを強制的に上書きするロジックを追加します。

### `src/lib/tools/nutritionValidator.ts`
- `validatePlanNutrition` が「信頼済みの固定メニュー」を受け取れるように拡張します。
- 固定メニュー設定があるスロットについては、バリデーションエラーを出さずにパスさせるようにします。

### `src/server/services/diet-baseline-service.ts`
- ユーザーの普段の食事量を超える提案を抑制するためのロジックを `createAdaptiveDirective` に追加します。
