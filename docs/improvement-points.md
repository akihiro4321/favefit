# テスト実行結果に基づく改善ポイント

## 概要

plan-creation-flow.mdのテストシナリオを実行した結果、以下の機能面・UX面・デザイン面での改善ポイントが確認されました。

---

## 機能面の修正ポイント

### 1. ネイティブダイアログの置き換え

**問題点:**
- `confirm()`と`alert()`を使用しているため、ブラウザのネイティブダイアログが表示される
- デザインの一貫性が損なわれる
- モバイルでの表示が最適化されていない

**影響箇所:**
- `src/app/plan/page.tsx`:
  - `handleRejectPlan()`: `confirm()`使用（197行目）
  - `handleRefreshPlan()`: `confirm()`使用（236行目）
  - `handleApprovePlan()`: `alert()`使用（185行目）
  - `handleRejectPlan()`: `alert()`使用（223行目）
  - `handleRefreshPlan()`: `alert()`使用（269行目）
  - `handleGeneratePlan()`: `alert()`使用（152行目）

**推奨対応:**
- Radix UIの`Dialog`コンポーネントを使用した確認ダイアログコンポーネントを作成
- トースト通知ライブラリ（例: `sonner`）を導入して`alert()`を置き換え
- カスタム確認ダイアログコンポーネントを作成（`components/ui/confirm-dialog.tsx`）

**優先度:** 🔴 高

---

### 2. プラン生成後の再取得タイミング

**問題点:**
- プラン生成API呼び出し後、即座にプランを再取得しているが、バックグラウンド処理が完了していない可能性がある
- `handleGeneratePlan()`で即座に再取得しているが、プランはまだ生成中かもしれない

**影響箇所:**
- `src/app/plan/page.tsx`の`handleGeneratePlan()`（129-156行目）
- `src/app/plan/page.tsx`の`handleRefreshPlan()`（232-279行目）

**推奨対応:**
- プラン生成API呼び出し後は、`planCreationStatus`が`"creating"`になることを確認
- プラン作成中画面を表示し、5秒ごとのポーリングでプラン生成完了を待つ
- プラン生成完了後、自動的にPending状態のプランを表示

**優先度:** 🟡 中

---

### 3. エラーハンドリングの改善

**問題点:**
- エラーが発生した場合、`console.error()`のみでユーザーに適切なフィードバックが提供されていない
- ネットワークエラーやタイムアウト時の処理が不十分

**影響箇所:**
- すべてのAPI呼び出し箇所

**推奨対応:**
- エラーメッセージをユーザーフレンドリーな形式で表示
- リトライ機能の実装（特にプラン生成時）
- エラーの種類に応じた適切な処理（ネットワークエラー、バリデーションエラーなど）

**優先度:** 🟡 中

---

## UX面の修正ポイント

### 4. プラン作成中画面の統一

**問題点:**
- プラン作成中画面のデザインが画面ごとに異なる
- `/home`では追加の説明文と「ホームに戻る」ボタンがあるが、`/plan`にはない
- `/onboarding`ではさらに異なるデザイン

**影響箇所:**
- `src/app/home/page.tsx`（89-112行目）
- `src/app/plan/page.tsx`（111-127行目）
- `src/app/onboarding/page.tsx`（329-364行目）

**推奨対応:**
- プラン作成中画面を共通コンポーネント化（`components/plan-creating-screen.tsx`）
- すべての画面で統一されたデザインとメッセージを表示
- 「このページを開いたままお待ちいただくか、しばらくしてから再度アクセスしてください」という説明を統一

**優先度:** 🟡 中

---

### 5. ローディング状態の表示改善

**問題点:**
- プラン生成開始直後に「読み込み中...」が表示されるが、すぐにプラン作成中画面に切り替わる
- 状態遷移が不安定に見える可能性がある

**影響箇所:**
- `src/app/plan/page.tsx`の`handleGeneratePlan()`（129-156行目）

**推奨対応:**
- プラン生成API呼び出し前に`planCreationStatus`を`"creating"`に設定
- ローディング状態とプラン作成中状態を明確に分離
- スムーズな状態遷移を実現

**優先度:** 🟢 低

---

### 6. プラン拒否後のフィードバック

**問題点:**
- プランを拒否した後、新しいプランが自動生成されるが、ユーザーに明確なフィードバックがない
- 拒否後にプランなし状態に戻るのか、新しいプランが生成されるのかが不明確

**影響箇所:**
- `src/app/plan/page.tsx`の`handleRejectPlan()`（194-230行目）

**推奨対応:**
- プラン拒否後、新しいプランが自動生成されることを明確に伝える
- プラン生成中の状態を表示
- 「プランを拒否しました。新しいプランを生成しています...」などのメッセージを表示

**優先度:** 🟡 中

---

### 7. 一括再生成後のフィードバック

**問題点:**
- 一括再生成後、`alert()`でメッセージを表示しているが、プラン作成中画面への遷移が不明確
- ユーザーが次に何をすべきかが不明確

**影響箇所:**
- `src/app/plan/page.tsx`の`handleRefreshPlan()`（232-279行目）

**推奨対応:**
- 一括再生成後、自動的にプラン作成中画面を表示
- トースト通知で「プラン再生成を開始しました」と表示
- プラン生成完了後、Pending状態のプランを自動表示

**優先度:** 🟡 中

---

## デザイン面の修正ポイント

### 8. 確認ダイアログのデザイン統一

**問題点:**
- `confirm()`を使用しているため、ブラウザのネイティブダイアログが表示される
- アプリのデザインシステムと一致しない

**推奨対応:**
- Radix UIの`Dialog`コンポーネントを使用した確認ダイアログを作成
- アプリのデザインシステムに合わせたスタイリング
- モバイル対応のレスポンシブデザイン

**優先度:** 🔴 高

---

### 9. エラーメッセージのデザイン統一

**問題点:**
- `alert()`を使用しているため、ブラウザのネイティブアラートが表示される
- エラーメッセージのデザインが統一されていない

**推奨対応:**
- トースト通知ライブラリ（例: `sonner`）を導入
- エラーメッセージをトースト通知で表示
- 成功メッセージとエラーメッセージで異なるスタイルを適用

**優先度:** 🔴 高

---

### 10. プラン概要カードの視認性改善

**問題点:**
- プラン概要カードの情報量が多いが、視認性が低い可能性がある
- 平均栄養価の表示が小さく、目標との差分が分かりにくい

**影響箇所:**
- `src/components/plan-summary.tsx`

**推奨対応:**
- 平均栄養価の表示を大きく、視認性を向上
- 目標との差分をより目立つように表示（色やアイコンを使用）
- タグの表示を改善（折りたたみ可能にする、またはスクロール可能にする）

**優先度:** 🟢 低

---

### 11. 日別カードの情報密度

**問題点:**
- Pending状態の日別カードに多くの情報が表示されているが、視認性が低い可能性がある
- タグや栄養価の表示が小さく、読みにくい

**影響箇所:**
- `src/app/plan/page.tsx`の`DayCard`コンポーネント（516-551行目）

**推奨対応:**
- 情報の階層を明確にする（重要度に応じたフォントサイズや色の調整）
- タグの表示を改善（折りたたみ可能にする、または最大表示数を調整）
- レスポンシブデザインの改善（モバイルでの表示を最適化）

**優先度:** 🟢 低

---

### 12. 承認/拒否ボタンの配置とサイズ

**問題点:**
- 承認/拒否ボタンが画面下部に配置されているが、スクロールが必要な場合がある
- ボタンのサイズや配置が最適化されていない可能性がある

**影響箇所:**
- `src/app/plan/page.tsx`の承認/拒否ボタン（369-400行目）

**推奨対応:**
- ボタンを固定位置に配置（sticky footer）
- ボタンのサイズと配置を最適化
- モバイルでの表示を改善

**優先度:** 🟢 低

---

## パフォーマンス面の修正ポイント

### 13. プラン再取得の最適化

**問題点:**
- プラン生成後、即座にプランを再取得しているが、バックグラウンド処理が完了していない可能性がある
- 5秒ごとのポーリングが効率的でない可能性がある

**推奨対応:**
- WebSocketまたはServer-Sent Events（SSE）を使用してリアルタイムでプラン生成完了を通知
- ポーリング間隔を最適化（初期は短く、時間が経つにつれて長くする）
- プラン生成完了の検知を改善

**優先度:** 🟢 低

---

## まとめ

### 優先度別の対応

**🔴 高優先度:**
1. ネイティブダイアログの置き換え（確認ダイアログ、アラート）
2. エラーメッセージのデザイン統一

**🟡 中優先度:**
3. プラン生成後の再取得タイミングの改善
4. プラン作成中画面の統一
5. プラン拒否後のフィードバック改善
6. 一括再生成後のフィードバック改善
7. エラーハンドリングの改善

**🟢 低優先度:**
8. ローディング状態の表示改善
9. プラン概要カードの視認性改善
10. 日別カードの情報密度改善
11. 承認/拒否ボタンの配置とサイズ改善
12. プラン再取得の最適化

---

## 実装の推奨順序

1. **確認ダイアログコンポーネントの作成**（高優先度）
   - Radix UIの`Dialog`を使用
   - `components/ui/confirm-dialog.tsx`を作成
   - `confirm()`を置き換え

2. **トースト通知の導入**（高優先度）
   - `sonner`などのトースト通知ライブラリを導入
   - `alert()`を置き換え

3. **プラン作成中画面の統一**（中優先度）
   - 共通コンポーネントを作成
   - すべての画面で統一されたデザインを適用

4. **プラン生成後の再取得タイミングの改善**（中優先度）
   - プラン生成API呼び出し後の処理を改善
   - プラン作成中画面への遷移を確実にする

5. **その他の改善**（低優先度）
   - デザインの細かい調整
   - パフォーマンスの最適化
